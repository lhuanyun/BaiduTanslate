name: Build Translation Tool

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-windows:
    name: Build for Windows
    runs-on: windows-latest
    
    defaults:
      run:
        shell: msys2 {0}

    steps:
    - uses: actions/checkout@v4

    # 1. 设置 MSYS2 环境 (这是在 Windows 上编译 CGO 程序的关键)
    # 我们需要安装 Tesseract 的开发库、GCC 编译器和 GUI 相关的库
    - uses: msys2/setup-msys2@v2
      with:
        update: true
        install: >-
          mingw-w64-x86_64-gcc
          mingw-w64-x86_64-go
          mingw-w64-x86_64-tesseract-ocr
          mingw-w64-x86_64-leptonica
          mingw-w64-x86_64-libx11
          mingw-w64-x86_64-xproto
          git
          base-devel

    # 2. 自动整理依赖 (因为你在网页上写代码，可能没有生成 go.sum)
    - name: Tidy Dependencies
      run: |
        export PATH=$PATH:/mingw64/bin
        go mod tidy

    # 3. 编译程序
    # 注意：去除 cmd 窗口通常用 -ldflags -H=windowsgui，但在调试阶段建议先保留以便看报错
    - name: Build
      run: |
        export PATH=$PATH:/mingw64/bin
        export CGO_ENABLED=1
        go build -v -o translator.exe main.go

    # 4. 上传编译结果
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: translator-windows-exe
        path: translator.exe
