name: Build Translator

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    name: Build Windows Exe
    runs-on: windows-latest
    
    defaults:
      run:
        shell: msys2 {0}

    steps:
    - uses: actions/checkout@v4

    # 1. 配置 MSYS2 环境 (这是编译 CGO 的关键)
    - uses: msys2/setup-msys2@v2
      with:
        update: true
        # 安装 Go, GCC, Tesseract开发库, X11库(Robotgo需要)
        install: >-
          mingw-w64-x86_64-go
          mingw-w64-x86_64-gcc
          mingw-w64-x86_64-tesseract-ocr
          mingw-w64-x86_64-leptonica
          mingw-w64-x86_64-libx11
          mingw-w64-x86_64-xproto
          git

    # 2. 下载依赖
    - name: Download Deps
      run: |
        export PATH=$PATH:/mingw64/bin
        go mod tidy

    # 3. 编译程序
    - name: Build
      run: |
        export PATH=$PATH:/mingw64/bin
        # 启用 CGO
        export CGO_ENABLED=1
        # 编译 -ldflags -H=windowsgui 去除黑窗口(cmd)
        go build -ldflags -H=windowsgui -o translator.exe main.go

    # 4. 上传结果
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: translator-windows
        path: translator.exe
